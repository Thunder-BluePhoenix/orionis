<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Orionis â€” Runtime Intelligence Engine</title>
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #0d0f14;
      --surface: #151820;
      --border: #1e2330;
      --accent: #6c8aff;
      --accent2: #a78bfa;
      --error: #ff5f5f;
      --ok: #4ade80;
      --text: #e2e8f0;
      --muted: #64748b;
      --font: 'Inter', system-ui, sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      font-size: 14px;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 20px;
      height: 52px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      background: var(--surface);
    }

    .logo {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: .5px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .tag {
      font-size: 11px;
      color: var(--muted);
      background: var(--border);
      padding: 2px 8px;
      border-radius: 99px;
    }

    .ws-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--muted);
      margin-left: auto;
      transition: background .3s;
    }

    .ws-dot.live {
      background: var(--ok);
      box-shadow: 0 0 6px var(--ok);
    }

    .ws-label {
      font-size: 11px;
      color: var(--muted);
    }

    /* AI Toggle */
    .ai-switch {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 16px;
      font-size: 11px;
      color: var(--muted);
      cursor: pointer;
    }

    .ai-switch input {
      display: none;
    }

    .switch-track {
      width: 28px;
      height: 14px;
      background: var(--border);
      border-radius: 20px;
      position: relative;
      transition: background .3s;
    }

    .switch-thumb {
      width: 10px;
      height: 10px;
      background: #fff;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform .3s;
    }

    input:checked+.switch-track {
      background: var(--accent2);
    }

    input:checked+.switch-track .switch-thumb {
      transform: translateX(14px);
    }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .layout {
      display: grid;
      grid-template-columns: 300px 1fr 320px;
      flex: 1;
      overflow: hidden;
    }

    .layout.diff-mode {
      grid-template-columns: 300px 1fr 1fr 0px;
      /* Hide locals in diff mode or adjust */
    }

    .panel {
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      overflow: hidden;
    }

    .panel:last-child {
      border-right: none;
    }

    .panel-header {
      padding: 12px 14px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .8px;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel-header .active-tab {
      color: var(--accent);
      border-bottom: 2px solid var(--accent);
      padding-bottom: 2px;
    }

    /* â”€â”€ Search bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .search-bar {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .search-bar input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 10px;
      color: var(--text);
      font-size: 12px;
      outline: none;
    }

    .search-bar input:focus {
      border-color: var(--accent);
    }

    /* â”€â”€ Diff banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .diff-banner {
      background: rgba(167, 139, 250, .1);
      border-bottom: 1px solid rgba(167, 139, 250, .2);
      padding: 8px 14px;
      font-size: 11px;
      color: var(--accent2);
      flex-shrink: 0;
      display: none;
    }

    .panel-body {
      flex: 1;
      overflow-y: auto;
    }

    /* â”€â”€ Trace List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .trace-item {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background .15s;
    }

    .trace-item:hover,
    .trace-item.active {
      background: rgba(108, 138, 255, .08);
    }

    .trace-item .fn-name {
      font-weight: 500;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .trace-item .meta {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      font-size: 11px;
      color: var(--muted);
    }

    .badge {
      padding: 1px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }

    .badge.error {
      background: rgba(255, 95, 95, .15);
      color: var(--error);
    }

    .badge.ok {
      background: rgba(74, 222, 128, .1);
      color: var(--ok);
    }

    .lang-badge {
      padding: 1px 6px;
      border-radius: 4px;
      font-size: 10px;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    /* â”€â”€ Timeline / Center â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 10px;
      color: var(--muted);
    }

    .empty-state .icon {
      font-size: 40px;
      opacity: .3;
    }

    /* Timeline slider */
    .timeline-bar {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .timeline-bar label {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    input[type=range] {
      width: 100%;
      accent-color: var(--accent);
      cursor: pointer;
    }

    /* Stack tree */
    .stack-tree {
      padding: 8px;
    }

    .span-node {
      margin-left: 12px;
      border-left: 2px solid var(--border);
      padding-left: 8px;
      margin-bottom: 2px;
    }

    .span-node .span-header {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 6px;
      border-radius: 5px;
      cursor: pointer;
      transition: background .15s;
    }

    .span-node .span-header:hover {
      background: rgba(255, 255, 255, .04);
    }

    .span-node.active-span .span-header {
      background: rgba(108, 138, 255, .12);
      border-left: 2px solid var(--accent);
    }

    .span-node.diverged .span-header {
      border-left: 2px solid var(--error) !important;
      background: rgba(255, 95, 95, .08);
    }

    .span-fn {
      font-weight: 500;
      font-size: 12px;
    }

    .span-time {
      font-size: 10px;
      color: var(--muted);
      margin-left: auto;
    }

    .span-type {
      font-size: 9px;
      padding: 1px 5px;
      border-radius: 3px;
      background: var(--border);
    }

    .span-type.exception {
      background: rgba(255, 95, 95, .2);
      color: var(--error);
    }

    .span-type.enter {
      background: rgba(108, 138, 255, .15);
      color: var(--accent);
    }

    .span-type.exit {
      background: rgba(74, 222, 128, .1);
      color: var(--ok);
    }

    .span-type.db {
      background: rgba(255, 171, 0, .15);
      color: #ffab00;
    }

    .span-thread {
      font-size: 9px;
      color: var(--muted);
      border: 1px solid var(--border);
      padding: 0 4px;
      border-radius: 4px;
    }

    /* â”€â”€ Locals Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .local-row {
      padding: 8px 14px;
      border-bottom: 1px solid var(--border);
    }

    .local-name {
      font-size: 11px;
      color: var(--accent);
      font-family: monospace;
    }

    .local-type {
      font-size: 10px;
      color: var(--muted);
      margin-left: 4px;
    }

    .local-value {
      font-size: 12px;
      font-family: monospace;
      margin-top: 3px;
      word-break: break-all;
      color: var(--text);
    }

    /* â”€â”€ Controls bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .controls {
      padding: 8px 12px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
      flex-shrink: 0;
      background: var(--surface);
    }

    button {
      background: var(--border);
      color: var(--text);
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: background .15s;
    }

    button:hover {
      background: #2a3045;
    }

    button.primary {
      background: var(--accent);
      color: white;
    }

    button.primary:hover {
      background: #5a79f0;
    }

    button.danger {
      background: rgba(255, 95, 95, .15);
      color: var(--error);
    }

    button.danger:hover {
      background: rgba(255, 95, 95, .25);
    }

    /* Scrollbars */
    ::-webkit-scrollbar {
      width: 5px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 99px;
    }

    /* SQL Highlighting */
    .sql-key {
      color: #ff79c6;
      font-weight: bold;
    }

    .sql-str {
      color: #f1fa8c;
    }

    .sql-num {
      color: #bd93f9;
    }

    .sql-fun {
      color: #50fa7b;
    }

    /* â”€â”€ AI Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ai-panel {
      padding: 14px;
      border-bottom: 1px solid var(--border);
      background: rgba(167, 139, 250, 0.05);
      display: none;
      animation: slideDown 0.4s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .ai-panel.active {
      display: block;
    }

    .ai-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--accent2);
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .ai-summary {
      font-size: 12px;
      line-height: 1.5;
      color: var(--text);
    }

    /* â”€â”€ Collaboration Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .comment-row {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .comment-user {
      font-size: 11px;
      font-weight: 600;
      color: var(--accent2);
    }

    .comment-text {
      margin-top: 4px;
      font-size: 12px;
      line-height: 1.4;
      color: var(--text);
    }

    .comment-time {
      font-size: 10px;
      color: var(--muted);
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>

  <!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header>
    <span class="logo">ORIONIS</span>
    <span class="tag">Runtime Intelligence Engine</span>
    <span class="tag" id="trace-count">0 traces</span>
    <div class="ws-dot" id="ws-dot"></div>
    <span class="ws-label" id="ws-label">Disconnected</span>
    </div>
    <label class="ai-switch" title="Connect/Disconnect Orionis AI">
      <span>AI Intelligence</span>
      <input type="checkbox" id="ai-toggle" onchange="toggleAI(this.checked)">
      <div class="switch-track">
        <div class="switch-thumb"></div>
      </div>
    </label>
  </header>

  <!-- â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="layout">

    <!-- Panel 1: Trace List -->
    <div class="panel">
      <div class="panel-header">
        <span>Traces</span>
        <button class="danger" onclick="clearAll()" style="padding:2px 8px;font-size:10px">Clear</button>
      </div>
      <div class="search-bar">
        <input type="text" id="search-input" placeholder="Filter by function, languageâ€¦" oninput="renderTraceList()">
      </div>
      <div class="diff-banner" id="diff-banner"></div>
      <div class="panel-body" id="trace-list">
        <div class="empty-state">
          <div class="icon">ðŸ“¡</div>
          <span>Waiting for tracesâ€¦</span>
          <span style="font-size:11px">Start your app with the Orionis agent</span>
        </div>
      </div>
    </div>

    <!-- Panel 2: Stack Tree + Timeline (Left/Primary) -->
    <div class="panel" id="primary-panel" style="border-right:none">
      <div class="panel-header">
        <div style="display:flex;gap:12px">
          <span style="cursor:pointer" id="tab-timeline" class="active-tab"
            onclick="switchTab('timeline')">Timeline</span>
          <span style="cursor:pointer" id="tab-flame" onclick="switchTab('flame')">Flamegraph</span>
          <span style="cursor:pointer" id="tab-graph" onclick="switchTab('graph')">Service Graph</span>
          <span style="cursor:pointer" id="tab-clusters" onclick="switchTab('clusters')">Failure Clusters</span>
          <span style="cursor:pointer" id="tab-nodes" onclick="switchTab('nodes')">Cluster Nodes</span>
        </div>
      </div>
      <div class="timeline-bar" id="timeline-bar" style="display:none">
        <label>
          <span>Step</span>
          <span id="step-label">0 / 0</span>
        </label>
        <input type="range" id="timeline-slider" min="0" value="0" oninput="onSlider(this.value)">
      </div>
      <div class="panel-body" id="stack-panel">
        <div class="empty-state">
          <div class="icon">ðŸ”­</div>
          <span>Select a trace to explore</span>
        </div>
      </div>

      <div class="panel-body" id="graph-panel" style="display:none;position:relative">
        <svg id="graph-svg" style="width:100%;height:100%"></svg>
        <div id="graph-tooltip"
          style="position:absolute;background:var(--surface);border:1px solid var(--border);padding:6px;border-radius:4px;font-size:11px;pointer-events:none;opacity:0;z-index:10">
        </div>
      </div>

      <div class="panel-body" id="flame-panel" style="display:none;padding:16px">
        <div id="flame-container" style="width:100%"></div>
      </div>

      <div class="panel-body" id="clusters-panel" style="display:none;padding:16px">
        <div id="clusters-container"></div>
      </div>

      <div class="panel-body" id="nodes-panel" style="display:none;padding:16px">
        <div id="nodes-container"></div>
      </div>
      <div class="controls" id="replay-controls" style="display:none">
        <button onclick="stepBack()">â—€ Back</button>
        <button onclick="togglePlay()" id="play-btn">â–¶ Play</button>
        <button onclick="stepForward()">Forward â–¶</button>
      </div>
    </div>

    <!-- Panel 2.5: (Right/Secondary) - Only in Diff Mode -->
    <div class="panel" id="secondary-panel" style="display:none;border-left:1px solid var(--border)">
      <div class="panel-header"><span>Comparison Trace</span></div>
      <div class="timeline-bar" id="timeline-bar-2">
        <label><span>Step</span><span id="step-label-2">0 / 0</span></label>
        <input type="range" id="timeline-slider-2" min="0" value="0" oninput="onSlider2(this.value)">
      </div>
      <div class="panel-body" id="stack-panel-2"></div>
    </div>

    <!-- Panel 3: Locals / Variable Inspector -->
    <div class="panel" id="locals-panel-container">
      <div class="panel-header"><span>Intelligence & Context</span></div>
      <div class="ai-panel" id="ai-panel">
        <div class="ai-title">âœ¨ ORIONIS AI INSIGHT</div>
        <div class="ai-summary" id="ai-summary">Analyzing trace patterns...</div>
      </div>
      <div class="panel-body" id="locals-panel">
        <div class="empty-state">
          <div class="icon">ðŸ”¬</div>
          <span>Select a frame</span>
        </div>
      </div>

      <!-- Collaboration Section -->
      <div class="panel-header" style="border-top: 1px solid var(--border)"><span>Collaboration</span></div>
      <div class="panel-body" id="comments-panel" style="flex: 0 0 240px; border-top: 1px solid var(--border)">
        <div class="empty-state" style="padding: 24px 0;">
          <span>No comments yet</span>
        </div>
      </div>
      <div class="search-bar"
        style="border-top: 1px solid var(--border); border-bottom: none; background: var(--surface)">
        <div style="display:flex; gap: 8px;">
          <input type="text" id="comment-input" placeholder="Add annotation..."
            onkeypress="if(event.key==='Enter') addComment()">
          <button class="primary" onclick="addComment()"
            style="padding: 4px 12px; height: 28px; display:flex; align-items:center">Post</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let traces = [];
    let events = [];
    let step = 0;
    let playing = false;
    let playTimer = null;
    let activeId = null;
    let currentTab = 'timeline';
    let diffMode = false;
    let diffEvents = [];
    let diffStep = 0;
    let diffActiveId = null;
    let divergenceIndex = -1;
    let aiEnabled = localStorage.getItem('aiEnabled') === 'true';

    // Initialize UI
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('ai-toggle').checked = aiEnabled;
      if (activeId) loadAISummary(activeId);
    });

    function toggleAI(enabled) {
      aiEnabled = enabled;
      localStorage.setItem('aiEnabled', enabled);
      if (activeId) loadAISummary(activeId);
      else document.getElementById('ai-panel').classList.remove('active');
    }

    async function loadAISummary(id) {
      const panel = document.getElementById('ai-panel');
      const summaryEl = document.getElementById('ai-summary');
      if (!aiEnabled) {
        panel.classList.remove('active');
        return;
      }
      panel.classList.add('active');
      summaryEl.textContent = 'Thinking...';
      try {
        const res = await fetch(`/api/ai/summarize/${id}`);
        const data = await res.json();
        summaryEl.innerHTML = `<p>${data.summary}</p><p style="margin-top:8px;font-size:11px;color:var(--muted)"><b>Rec:</b> ${data.recommendation}</p>`;
      } catch (e) {
        summaryEl.textContent = 'AI analysis failed.';
      }
    }

    // â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function connectWs() {
      const ws = new WebSocket(`ws://${location.host}/ws/live`);
      const dot = document.getElementById('ws-dot');
      const lbl = document.getElementById('ws-label');
      ws.onopen = () => { dot.classList.add('live'); lbl.textContent = 'Live'; loadTraces(); };
      ws.onclose = () => { dot.classList.remove('live'); lbl.textContent = 'Reconnectingâ€¦'; setTimeout(connectWs, 2000); };
      ws.onmessage = () => loadTraces();
    }

    // â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadTraces() {
      const res = await fetch('/api/traces');
      traces = await res.json();
      renderTraceList();
    }

    async function loadTrace(id) {
      const res = await fetch(`/api/traces/${id}`);
      events = await res.json();
      activeId = id;
      step = 0;
      loadAISummary(id);
      loadComments(id);
      if (diffMode) renderDiff(); // Just update primary side
      else {
        renderTimeline();
        renderStack();
      }
    }

    async function loadComments(id) {
      const panel = document.getElementById('comments-panel');
      if (!panel) return;
      panel.innerHTML = '<div style="padding:14px;font-size:11px;color:var(--muted)">Loading comments...</div>';
      try {
        const res = await fetch(`/api/traces/${id}/comments`);
        const comments = await res.json();
        if (comments.length === 0) {
          panel.innerHTML = '<div class="empty-state" style="padding:24px 0;"><span>No annotations yet</span></div>';
        } else {
          panel.innerHTML = comments.map(c => `
            <div class="comment-row">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <span class="comment-user">@${c.user_id}</span>
                <span class="comment-time">${new Date(c.timestamp_ms).toLocaleTimeString()}</span>
              </div>
              <div class="comment-text">${escHtml(c.text)}</div>
              ${c.span_id ? `<div style="font-size:9px;color:var(--accent);margin-top:4px">Pinned to span ${c.span_id.slice(0, 8)}</div>` : ''}
            </div>
          `).join('');
        }
      } catch (e) {
        panel.innerHTML = '<div style="padding:14px;color:var(--error)">Failed to load comments</div>';
      }
    }

    async function addComment() {
      const input = document.getElementById('comment-input');
      const text = input.value.trim();
      if (!text || !activeId) return;

      const payload = {
        text: text,
        user_id: 'engineer',
        span_id: events[step]?.span_id
      };

      try {
        const res = await fetch(`/api/traces/${activeId}/comments`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (res.status === 201) {
          input.value = '';
          loadComments(activeId);
        }
      } catch (e) {
        console.error('Comment error:', e);
      }
    }

    async function loadDiff(id) {
      const res = await fetch(`/api/traces/${id}`);
      diffEvents = await res.json();
      diffActiveId = id;
      diffStep = 0;
      diffMode = true;
      document.querySelector('.layout').classList.add('diff-mode');
      document.getElementById('secondary-panel').style.display = '';
      calculateDivergence();
      renderDiff();
    }

    function calculateDivergence() {
      if (!diffMode || !events.length || !diffEvents.length) {
        divergenceIndex = -1;
        return;
      }
      const minLen = Math.min(events.length, diffEvents.length);
      for (let i = 0; i < minLen; i++) {
        if (events[i].function_name !== diffEvents[i].function_name ||
          events[i].module !== diffEvents[i].module ||
          events[i].event_type !== diffEvents[i].event_type) {
          divergenceIndex = i;
          return;
        }
      }
      divergenceIndex = minLen < Math.max(events.length, diffEvents.length) ? minLen : -1;
    }

    function renderDiff() {
      renderTimeline();
      renderStack();
      renderTimeline2();
      renderStack2();
    }

    async function clearAll() {
      await fetch('/api/clear', { method: 'DELETE' });
      traces = []; events = []; activeId = null;
      renderTraceList();
      resetCenter();
    }

    async function replayRequest(spanId) {
      const res = await fetch(`/api/replay/${spanId}`, { method: 'POST' });
      const msg = await res.text();
      alert(msg);
      loadTraces();
    }

    // â”€â”€ Render: Trace List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderTraceList() {
      const el = document.getElementById('trace-list');
      document.getElementById('trace-count').textContent = `${traces.length} trace${traces.length !== 1 ? 's' : ''}`;

      // Apply search filter
      const q = (document.getElementById('search-input')?.value || '').toLowerCase();
      const visible = q
        ? traces.filter(t =>
          t.name.toLowerCase().includes(q) ||
          t.language.toLowerCase().includes(q) ||
          t.trace_id.toLowerCase().includes(q))
        : traces;

      if (!visible.length) {
        el.innerHTML = `<div class="empty-state"><div class="icon">ðŸ“¡</div><span>${q ? 'No matches' : 'Waiting for tracesâ€¦'}</span></div>`;
        return;
      }
      el.innerHTML = visible.map(t => `
    <div class="trace-item ${t.trace_id === activeId ? 'active' : ''}" onclick="loadTrace('${t.trace_id}')">
      <div style="display:flex; justify-content:space-between">
        <div class="fn-name">${t.name}</div>
        <button class="badge" style="background:var(--border);color:var(--muted);padding:0 4px" onclick="event.stopPropagation(); loadDiff('${t.trace_id}')">Diff</button>
      </div>
      <div class="meta">
        <span class="badge ${t.has_error ? 'error' : 'ok'}">${t.has_error ? 'âœ• Error' : 'âœ“ OK'}</span>
        <span class="lang-badge">${t.language}</span>
        <span>${t.event_count} events</span>
        <span>${t.duration_ms != null ? t.duration_ms + ' ms' : 'â€”'}</span>
      </div>
    </div>`).join('');
    }

    // â”€â”€ Render: Timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderTimeline() {
      const bar = document.getElementById('timeline-bar');
      const slider = document.getElementById('timeline-slider');
      const controls = document.getElementById('replay-controls');
      if (!events.length) { bar.style.display = 'none'; controls.style.display = 'none'; return; }
      bar.style.display = '';
      controls.style.display = '';
      slider.max = events.length - 1;
      slider.value = step;
      document.getElementById('step-label').textContent = `${step + 1} / ${events.length}`;
    }

    // â”€â”€ Render: Stack Tree â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderStack() {
      const panel = document.getElementById('stack-panel');
      if (!events.length) { panel.innerHTML = `<div class="empty-state"><div class="icon">ðŸ”­</div><span>No events</span></div>`; return; }

      const visible = events.slice(0, step + 1);
      const current = events[step];

      panel.innerHTML = `<div class="stack-tree">` +
        visible.map((e, i) => {
          const isDiverged = diffMode && divergenceIndex !== -1 && i >= divergenceIndex;
          return `
      <div class="span-node ${i === step ? 'active-span' : ''} ${isDiverged ? 'diverged' : ''}" onclick="goTo(${i})">
        <div class="span-header">
          <span class="span-type ${typeClass(e.event_type)}">${shortType(e.event_type)}</span>
          <span class="span-fn">${e.function_name}</span>
          ${e.thread_id ? `<span class="span-thread">T:${e.thread_id}</span>` : ''}
          ${e.http_request ? `<button class="badge" style="background:var(--accent);color:white;padding:0 4px" onclick="event.stopPropagation(); replayRequest('${e.span_id}')">Replay</button>` : ''}
          <span style="font-size:10px;color:var(--muted)">${e.file}:${e.line}</span>
          ${e.db_query ? `<div style="margin-top:6px;padding:8px;background:rgba(0,0,0,0.2);border-radius:4px;font-family:monospace;font-size:11px;border-left:2px solid #ffab00">${renderSql(e.db_query.query)} <span style="color:var(--muted);margin-left:8px">[${e.db_query.driver}]</span></div>` : ''}
          <span class="span-time">${relTime(e.timestamp_ms)}</span>
        </div>
      </div>`;
        }).join('') +
        `</div>`;

      renderLocals(current);
      panel.scrollTop = panel.scrollHeight;
    }

    // â”€â”€ Render: Locals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderLocals(event) {
      const el = document.getElementById('locals-panel');
      if (!event?.locals?.length) {
        el.innerHTML = `<div class="local-row" style="color:var(--muted);font-size:12px">No variables captured for this frame</div>`;
        return;
      }
      el.innerHTML = event.locals.map(l => `
    <div class="local-row">
      <div><span class="local-name">${l.name}</span><span class="local-type">${l.type_name}</span></div>
      <div class="local-value">${escHtml(l.value)}</div>
    </div>`).join('');
    }

    // â”€â”€ Playback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function onSlider(v) {
      step = +v;
      renderTimeline(); renderStack();
      if (diffMode && diffEvents.length > step) {
        diffStep = step; renderTimeline2(); renderStack2();
      }
    }
    function onSlider2(v) { diffStep = +v; renderTimeline2(); renderStack2(); }

    function renderTimeline2() {
      const slider = document.getElementById('timeline-slider-2');
      slider.max = diffEvents.length - 1;
      slider.value = diffStep;
      document.getElementById('step-label-2').textContent = `${diffStep + 1} / ${diffEvents.length}`;
    }

    function renderStack2() {
      const panel = document.getElementById('stack-panel-2');
      const visible = diffEvents.slice(0, diffStep + 1);
      panel.innerHTML = `<div class="stack-tree">` +
        visible.map((e, i) => {
          const isDiverged = diffMode && divergenceIndex !== -1 && i >= divergenceIndex;
          return `
            <div class="span-node ${i === diffStep ? 'active-span' : ''} ${isDiverged ? 'diverged' : ''}">
                <div class="span-header">
                    <span class="span-type ${typeClass(e.event_type)}">${shortType(e.event_type)}</span>
                    <span class="span-fn">${e.function_name}</span>
                </div>
            </div>`;
        }).join('') + `</div>`;
    }

    function goTo(i) { step = i; stopPlay(); renderTimeline(); renderStack(); }
    function stepBack() { if (step > 0) { step--; renderTimeline(); renderStack(); } }
    function stepForward() { if (step < events.length - 1) { step++; renderTimeline(); renderStack(); } }
    function jumpToStart() { step = 0; renderTimeline(); renderStack(); }
    function jumpToEnd() { step = events.length - 1; renderTimeline(); renderStack(); }

    // â”€â”€ Service Graph â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function switchTab(tab) {
      currentTab = tab;
      document.getElementById('tab-timeline').className = tab === 'timeline' ? 'active-tab' : '';
      document.getElementById('tab-flame').className = tab === 'flame' ? 'active-tab' : '';
      document.getElementById('tab-graph').className = tab === 'graph' ? 'active-tab' : '';
      document.getElementById('tab-clusters').className = tab === 'clusters' ? 'active-tab' : '';
      document.getElementById('tab-nodes').className = tab === 'nodes' ? 'active-tab' : '';

      document.getElementById('stack-panel').style.display = tab === 'timeline' ? '' : 'none';
      document.getElementById('timeline-bar').style.display = (tab === 'timeline' || tab === 'flame') && events.length ? '' : 'none';
      document.getElementById('replay-controls').style.display = (tab === 'timeline' || tab === 'flame') && events.length ? '' : 'none';

      document.getElementById('graph-panel').style.display = tab === 'graph' ? '' : 'none';
      document.getElementById('flame-panel').style.display = tab === 'flame' ? '' : 'none';
      document.getElementById('clusters-panel').style.display = tab === 'clusters' ? '' : 'none';
      document.getElementById('nodes-panel').style.display = tab === 'nodes' ? '' : 'none';

      if (tab === 'graph') loadGraph();
      if (tab === 'flame') renderFlamegraph();
      if (tab === 'clusters') loadClusters();
      if (tab === 'nodes') loadNodes();
    }

    async function loadNodes() {
      const res = await fetch('/api/nodes');
      const nodes = await res.json();
      renderNodes(nodes);
    }

    function renderNodes(nodes) {
      const el = document.getElementById('nodes-container');
      if (!nodes.length) {
        el.innerHTML = `<div class="empty-state">No cluster nodes detected</div>`;
        return;
      }
      el.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:16px">
          ${nodes.map(n => {
        const isLive = (Date.now() - n.last_seen) < 15000;
        return `
            <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;display:flex;flex-direction:column;gap:12px">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <span style="font-weight:600;font-size:13px">${isLive ? 'ðŸŸ¢' : 'ðŸ”´'} Node ${n.node_id.slice(0, 8)}</span>
                <span class="badge ${n.status === 'active' ? 'ok' : 'error'}">${n.status}</span>
              </div>
              <div style="font-size:11px;color:var(--muted)">
                <div><b>HTTP:</b> ${n.http_addr}</div>
                <div><b>gRPC:</b> ${n.grpc_addr}</div>
                <div style="margin-top:4px"><b>Last Seen:</b> ${new Date(n.last_seen).toLocaleTimeString()}</div>
              </div>
            </div>`;
      }).join('')}
        </div>`;
    }

    async function loadClusters() {
      const res = await fetch('/api/clusters');
      const clusters = await res.json();
      renderClusters(clusters);
    }

    function renderClusters(clusters) {
      const el = document.getElementById('clusters-container');
      if (!clusters.length) {
        el.innerHTML = `<div class="empty-state">No failure clusters detected yet</div>`;
        return;
      }
      el.innerHTML = clusters.map(c => `
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <span style="font-family:monospace;font-size:12px;color:var(--error);word-break:break-all">${c.cluster_key}</span>
            <span class="badge error">${c.count} occurrences</span>
          </div>
          <div style="font-size:13px;color:var(--text);margin-bottom:12px">
            <b>Pattern:</b> ${c.representative.name} in ${c.representative.language}
          </div>
          <div style="display:flex;gap:8px;overflow-x:auto;padding-bottom:8px">
            ${c.traces.map(t => `<button class="badge" style="background:var(--border);color:var(--muted)" onclick="switchTab('timeline');loadTrace('${t.trace_id}')">${t.trace_id.slice(0, 8)}</button>`).join('')}
          </div>
        </div>
      `).join('');
    }

    async function loadGraph() {
      const res = await fetch('/api/graph');
      const data = await res.json();
      renderGraph(data);
    }

    function renderGraph(data) {
      const svg = d3.select("#graph-svg");
      svg.selectAll("*").remove();

      const width = document.getElementById('graph-panel').clientWidth;
      const height = document.getElementById('graph-panel').clientHeight;
      if (!width || !height) return;

      const simulation = d3.forceSimulation(data.nodes)
        .force("link", d3.forceLink(data.links).id(d => d.id).distance(100))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(width / 2, height / 2));

      // Arrow markers
      svg.append("defs").append("marker")
        .attr("id", "arrowhead")
        .attr("viewBox", "-0 -5 10 10")
        .attr("refX", 20)
        .attr("refY", 0)
        .attr("orient", "auto")
        .attr("markerWidth", 6)
        .attr("markerHeight", 6)
        .attr("xoverflow", "visible")
        .append("svg:path")
        .attr("d", "M 0,-5 L 10 ,0 L 0,5")
        .attr("fill", "var(--muted)")
        .style("stroke", "none");

      const link = svg.append("g")
        .selectAll("line")
        .data(data.links)
        .join("line")
        .attr("stroke", "var(--border)")
        .attr("stroke-width", d => Math.sqrt(d.count) + 1)
        .attr("marker-end", "url(#arrowhead)");

      const node = svg.append("g")
        .selectAll("g")
        .data(data.nodes)
        .join("g")
        .call(drag(simulation));

      node.append("circle")
        .attr("r", 12)
        .attr("fill", "var(--surface)")
        .attr("stroke", "var(--accent)")
        .attr("stroke-width", 2);

      node.append("text")
        .text(d => d.label)
        .attr("x", 16)
        .attr("y", 4)
        .attr("fill", "var(--text)")
        .style("font-size", "11px");

      simulation.on("tick", () => {
        link
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);
        node
          .attr("transform", d => `translate(${d.x},${d.y})`);
      });

      function drag(simulation) {
        return d3.drag()
          .on("start", (event) => {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
          })
          .on("drag", (event) => {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
          })
          .on("end", (event) => {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
          });
      }
    }

    // â”€â”€ Flamegraph â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderFlamegraph() {
      const el = document.getElementById('flame-container');
      el.innerHTML = '';
      if (!events.length) return;

      // 1. Build hierarchy
      const enterEvents = events.filter(e => e.event_type === 'FunctionEnter');
      if (!enterEvents.length) {
        el.innerHTML = '<div class="empty-state">No call stack data available for flamegraph</div>';
        return;
      }

      // Find root (usually event with no parent_span_id, or first one)
      const roots = enterEvents.filter(e => !e.parent_span_id);
      const root = roots.length ? roots[0] : enterEvents[0];

      const durationMap = new Map();
      events.forEach(e => {
        if (e.event_type === 'FunctionExit' && e.parent_span_id) {
          durationMap.set(e.parent_span_id, e.duration_us);
        }
      });

      function buildNode(ev) {
        const children = enterEvents.filter(c => c.parent_span_id === ev.span_id);
        const dur = durationMap.get(ev.span_id) || 0;
        return {
          name: ev.function_name,
          value: dur,
          start: ev.timestamp_ms,
          children: children.map(buildNode)
        };
      }

      const data = buildNode(root);

      // 2. Render using D3
      const width = el.clientWidth || 800;
      const rowHeight = 24;
      const hierarchy = d3.hierarchy(data).sum(d => d.value);
      const root_node = d3.partition().size([width, (hierarchy.height + 1) * rowHeight])(hierarchy);

      const svg = d3.select(el).append("svg")
        .attr("width", width)
        .attr("height", (hierarchy.height + 1) * rowHeight)
        .style("font-family", "var(--font)")
        .style("font-size", "10px");

      const color = d3.scaleOrdinal(d3.schemeAccent);

      const cell = svg.selectAll("g")
        .data(root_node.descendants())
        .join("g")
        .attr("transform", d => `translate(${d.x0},${d.y0})`);

      cell.append("rect")
        .attr("width", d => Math.max(0, d.x1 - d.x0 - 1))
        .attr("height", rowHeight - 1)
        .attr("fill", d => color(d.data.name))
        .attr("rx", 2)
        .style("cursor", "pointer")
        .on("mouseover", function (event, d) {
          d3.select(this).attr("opacity", 0.8);
          // Show tooltip if needed
        })
        .on("mouseout", function () {
          d3.select(this).attr("opacity", 1);
        });

      cell.append("text")
        .attr("x", 4)
        .attr("y", 16)
        .attr("fill", "white")
        .style("pointer-events", "none")
        .text(d => {
          const w = d.x1 - d.x0;
          const label = `${d.data.name} (${(d.data.value / 1000).toFixed(2)}ms)`;
          return w > 50 ? label : (w > 20 ? d.data.name : "");
        });
    }

    function togglePlay() {
      if (playing) { stopPlay(); return; }
      playing = true;
      document.getElementById('play-btn').textContent = 'â¸ Pause';
      playTimer = setInterval(() => {
        if (step >= events.length - 1) { stopPlay(); return; }
        step++;
        renderTimeline();
        renderStack();
      }, 300);
    }

    function stopPlay() {
      playing = false;
      clearInterval(playTimer);
      const btn = document.getElementById('play-btn');
      if (btn) btn.textContent = 'â–¶ Play';
    }

    function resetCenter() {
      document.getElementById('stack-panel').innerHTML = `<div class="empty-state"><div class="icon">ðŸ”­</div><span>Select a trace to explore</span></div>`;
      document.getElementById('locals-panel').innerHTML = `<div class="empty-state"><div class="icon">ðŸ”¬</div><span>Select a frame</span></div>`;
      document.getElementById('timeline-bar').style.display = 'none';
      document.getElementById('replay-controls').style.display = 'none';
    }

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let t0 = null;
    function relTime(ms) {
      if (!t0) t0 = ms;
      const d = ms - t0;
      return d < 1000 ? `+${d}ms` : `+${(d / 1000).toFixed(2)}s`;
    }

    function typeClass(t) {
      if (!t) return '';
      const tl = t.toLowerCase();
      if (tl.includes('exception')) return 'exception';
      if (tl.includes('exit')) return 'exit';
      return 'enter';
    }

    function shortType(t) {
      if (!t) return '?';
      const map = { FunctionEnter: 'ENTER', FunctionExit: 'EXIT', Exception: 'EXCEPTION', AsyncSpawn: 'SPAWN', AsyncResume: 'RESUME', HttpRequest: 'HTTPâ†’', HttpResponse: 'â†HTTP', DbQuery: 'SQL' };
      return map[t] || t;
    }

    function renderSql(sql) {
      if (!sql) return '';
      const keywords = /\b(SELECT|FROM|WHERE|INSERT|INTO|UPDATE|DELETE|JOIN|LEFT|RIGHT|INNER|ON|GROUP|BY|ORDER|LIMIT|HAVING|VALUES|SET|CREATE|TABLE|DROP|INDEX|ALTER)\b/gi;
      const strings = /'[^']*'/g;
      const numbers = /\b\d+\b/g;

      return escHtml(sql)
        .replace(keywords, m => `<span class="sql-key">${m.toUpperCase()}</span>`)
        .replace(strings, m => `<span class="sql-str">${m}</span>`)
        .replace(numbers, m => `<span class="sql-num">${m}</span>`);
    }

    function escHtml(s) { return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

    // â”€â”€ URL Param Handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Supports: ?trace=<id>  and  ?diff=<id-a>,<id-b>

    async function handleUrlParams() {
      const params = new URLSearchParams(location.search);

      // ?diff=a,b â€” show diff banner and load first trace
      const diffParam = params.get('diff');
      if (diffParam) {
        const [idA, idB] = diffParam.split(',').map(s => s.trim());
        const banner = document.getElementById('diff-banner');
        if (banner) {
          banner.style.display = '';
          banner.textContent = `âš¡ Diff mode: ${idA?.slice(0, 8)}â€¦ vs ${idB?.slice(0, 8)}â€¦ (full diff view in Phase 2)`;
        }
        if (idA) await loadTrace(idA);
        return;
      }

      // ?trace=<id> â€” auto-select trace (used by orion replay)
      const replayId = params.get('trace');
      if (replayId) {
        // Retry a few times â€” traces load asynchronously
        for (let attempt = 0; attempt < 10; attempt++) {
          if (traces.find(t => t.trace_id === replayId)) {
            await loadTrace(replayId);
            // Scroll that item into view
            const items = document.querySelectorAll('.trace-item');
            items.forEach(el => { if (el.textContent.includes(replayId.slice(0, 8))) el.scrollIntoView(); });
            return;
          }
          await new Promise(r => setTimeout(r, 300));
        }
        console.warn('[Orionis] Trace not found for replay:', replayId);
      }
    }

    // â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    connectWs();
    setTimeout(handleUrlParams, 600);  // run after initial WebSocket load completes
  </script>
</body>

</html>